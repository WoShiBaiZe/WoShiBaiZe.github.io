<!DOCTYPE html>



  


<html class="theme-next beep use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







  

<link href="https://cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="工作总结,">










<meta name="description" content="Insert是行锁还是表锁？[toc] 一、前言项目中遇到一个很奇怪的问题：问题描述：现在需要从项目外部导大量的数据到项目内，这个时候我起了一个spring事务往很多张表中去插入数据，这个时候其他用户访问系统去更新旧的数据的时候发现表被锁了。也就是说我在导入数据的时候，其他用户都不能对系统的表进行相应的更新操作。这是为什么？？？？于是想要了解一下insert加锁机制，但是发现网上介绍的文章比较少且">
<meta name="keywords" content="工作总结">
<meta property="og:type" content="article">
<meta property="og:title" content="insert是行锁还是表锁？">
<meta property="og:url" content="https://woshibaize.github.io/2020/02/01/每日总结/20200201/index.html">
<meta property="og:site_name" content="个人博客">
<meta property="og:description" content="Insert是行锁还是表锁？[toc] 一、前言项目中遇到一个很奇怪的问题：问题描述：现在需要从项目外部导大量的数据到项目内，这个时候我起了一个spring事务往很多张表中去插入数据，这个时候其他用户访问系统去更新旧的数据的时候发现表被锁了。也就是说我在导入数据的时候，其他用户都不能对系统的表进行相应的更新操作。这是为什么？？？？于是想要了解一下insert加锁机制，但是发现网上介绍的文章比较少且">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-09-01T04:55:41.303Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="insert是行锁还是表锁？">
<meta name="twitter:description" content="Insert是行锁还是表锁？[toc] 一、前言项目中遇到一个很奇怪的问题：问题描述：现在需要从项目外部导大量的数据到项目内，这个时候我起了一个spring事务往很多张表中去插入数据，这个时候其他用户访问系统去更新旧的数据的时候发现表被锁了。也就是说我在导入数据的时候，其他用户都不能对系统的表进行相应的更新操作。这是为什么？？？？于是想要了解一下insert加锁机制，但是发现网上介绍的文章比较少且">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Beep',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":6,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://woshibaize.github.io/2020/02/01/每日总结/20200201/">



<!-- 文章加密 -->
<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
		if (history.length === 1) {
		    window.opener = null;
		    window.open('', '_self');
		    window.close();
                } else {
                    history.back();
                }
            }
        }
    })();
</script>

<!-- fontawesome5 -->
<link href="/lib/font-awesome/css/fontawesome-all.min.css" rel="stylesheet" type="text/css">

  <title>insert是行锁还是表锁？ | 个人博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband">
	<a href="https://github.com/woshibaize" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="/images/headband/forkme_right_red.png" alt="Fork me on GitHub"></a>
    </div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">personal blog</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa-fw fas fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa-fw fas fa-archive"></i> <br>
            
            文章
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa-fw fas fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa-fw fas fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa-fw fas fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fas fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fas fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="far fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>


 </div>
    </header>
    
    <a href="https://github.com/woshibaize" class="github-corner" target="_blank" title="Follow me on GitHub" aria-label="Follow me on GitHub">
      <svg width="80" height="80" viewbox="0 0 250 250" style="fill:#222; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/>
	<path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/>
      </svg>
    </a>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://woshibaize.github.io/2020/02/01/每日总结/20200201/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="BaiZe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">insert是行锁还是表锁？</h2>
        

        <div class="post-meta">
	  
	  
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="far fa-calendar-plus"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-01T18:27:27+08:00">
                2020-02-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工作总结/" itemprop="url" rel="index">
                    <span itemprop="name">工作总结</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <!--<i class="far fa-file-word"></i>-->
		  <i class="fas fa-book-open"></i>
                </span>
                
                  <span class="post-meta-item-text">本文共计 &#58;</span>
                
                <span title="本文共计">
                  5.1k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="far fa-clock"></i>
                </span>
                
                  <span class="post-meta-item-text">阅文耗时 &asymp;</span>
                
                <span title="阅文耗时">
                  23 min
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Insert是行锁还是表锁？"><a href="#Insert是行锁还是表锁？" class="headerlink" title="Insert是行锁还是表锁？"></a><center>Insert是行锁还是表锁？</center></h2><p>[toc]</p>
<h5 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h5><p>项目中遇到一个很奇怪的问题：<br>问题描述：现在需要从项目外部导大量的数据到项目内，这个时候我起了一个spring事务往很多张表中去插入数据，这个时候其他用户访问系统去更新旧的数据的时候发现表被锁了。也就是说我在导入数据的时候，其他用户都不能对系统的表进行相应的更新操作。这是为什么？？？？<br>于是想要了解一下insert加锁机制，但是发现网上介绍的文章比较少且零散，挖掘过程比较忙乱。</p>
<p>本以为只需要系统学习一个较完全的逻辑，但是实际牵扯很多innodb锁相关知识及加锁方式。我好像并没有那么大的能耐，把各种场景的加锁过程一一列举并加之分析；亦没有太多的精力验证网上的言论的准确性。</p>
<p>只好根据现在了解的内容，参考官方文档，说说自己当前的理解。<br>本文仅供参考，如有误导，概不负责。</p>
<p>答：数据库的事务机制就是这样，insert时全表锁，因为要生成主键字段、索引等等，update是行级锁。同时对一张表进行读写操作，会产生‘脏’数据，导致读、写两端的数据不一致。当然了，这是要在绝对意义上的‘同时’情况下才会发生。</p>
<h5 id="二、现场状态"><a href="#二、现场状态" class="headerlink" title="二、现场状态"></a>二、现场状态</h5><p>不同的mysql版本，不同的参数设置，都可能对加锁过程有影响。<br>分析加锁机制还是应当尽可能多地列举一下关键参数，例如：当前mysql版本、事务隔离级别等。<br>如下，仅仅只列出个别比较重要的参数。</p>
<h6 id="1-数据库版本"><a href="#1-数据库版本" class="headerlink" title="1.数据库版本"></a>1.数据库版本</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select version();</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| version() |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| 5.6.27    |</span><br><span class="line">+<span class="comment">-----------+</span></span><br></pre></td></tr></table></figure>
<h6 id="2-数据库引擎"><a href="#2-数据库引擎" class="headerlink" title="2.数据库引擎"></a>2.数据库引擎</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like '%engine%';</span><br><span class="line">+<span class="comment">----------------------------+--------+</span></span><br><span class="line">| Variable_name 			 | Value  |</span><br><span class="line">+<span class="comment">----------------------------+--------+</span></span><br><span class="line">| default_storage_engine 	 | InnoDB |</span><br><span class="line">| default_tmp_storage_engine | InnoDB |</span><br><span class="line">| storage_engine 			 | InnoDB |</span><br><span class="line">+<span class="comment">----------------------------+--------+</span></span><br></pre></td></tr></table></figure>
<p>注：InnoDB支持事务，Myisam不支持事务；InnoDB支持行锁和表锁；Myisam不支持行锁。</p>
<h6 id="3-事务隔离级别"><a href="#3-事务隔离级别" class="headerlink" title="3.事务隔离级别"></a>3.事务隔离级别</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select @@global.tx_isolation, @@session.tx_isolation, @@tx_isolation;</span><br><span class="line">+<span class="comment">-----------------------+------------------------+-----------------+</span></span><br><span class="line">| @@global.tx_isolation | @@session.tx_isolation | @@tx_isolation  |</span><br><span class="line">+<span class="comment">-----------------------+------------------------+-----------------+</span></span><br><span class="line">| REPEATABLE-READ | REPEATABLE-READ | REPEATABLE-READ 			   |</span><br><span class="line">+<span class="comment">-----------------------+------------------------+-----------------+</span></span><br></pre></td></tr></table></figure>
<p>注：几种事务隔离级别：READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE</p>
<h6 id="4-查看gap锁开启状态"><a href="#4-查看gap锁开启状态" class="headerlink" title="4.查看gap锁开启状态"></a>4.查看gap锁开启状态</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;innodb_locks_unsafe_for_binlog&apos;;</span><br><span class="line">+--------------------------------+-------+</span><br><span class="line">| Variable_name 				 | Value |</span><br><span class="line">+--------------------------------+-------+</span><br><span class="line">| innodb_locks_unsafe_for_binlog | OFF   |</span><br><span class="line">+--------------------------------+-------+</span><br></pre></td></tr></table></figure>
<p>innodb_locks_unsafe_for_binlog：默认值为0，即启用gap lock。<br>最主要的作用就是控制innodb是否对gap加锁。<br>但是，这一设置变更并不影响外键和唯一索引（含主键）对gap进行加锁的需要。<br>开启innodb_locks_unsafe_for_binlog的REPEATABLE-READ事务隔离级别，很大程度上已经蜕变成了READ-COMMITTED。</p>
<p>参见官方文档[^1]：</p>
<blockquote>
<p>By default, the value of innodb_locks_unsafe_for_binlog is 0 (disabled), which means that gap locking is enabled: InnoDB uses next-key locks for searches and index scans. To enable the variable, set it to 1. This causes gap locking to be disabled: InnoDB uses only index-record locks for searches and index scans.</p>
<p>Enabling innodb_locks_unsafe_for_binlog does not disable the use of gap locking for foreign-key constraint checking or duplicate-key checking.</p>
<p>The effect of enabling innodb_locks_unsafe_for_binlog is similar to but not identical to setting the transaction isolation level to READ COMMITTED.</p>
</blockquote>
<h6 id="5-查看自增锁模式"><a href="#5-查看自增锁模式" class="headerlink" title="5. 查看自增锁模式"></a>5. 查看自增锁模式</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;innodb_autoinc_lock_mode&apos;;</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| Variable_name 		   | Value |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| innodb_autoinc_lock_mode | 1     |</span><br><span class="line">+--------------------------+-------+</span><br></pre></td></tr></table></figure>
<p>innodb_autoinc_lock_mode有3种配置模式：0、1、2，分别对应”传统模式”, “连续模式”, “交错模式”。[^8]<br>传统模式：涉及auto-increment列的插入语句加的表级AUTO-INC锁，只有插入执行结束后才会释放锁。这是一种兼容MySQL 5.1之前版本的策略。<br>连续模式：可以事先确定插入行数的语句(包括单行和多行插入)，分配连续的确定的auto-increment值；对于插入行数不确定的插入语句，仍加表锁。这种模式下，事务回滚，auto-increment值不会回滚，换句话说，自增列内容会不连续。<br>交错模式：同一时刻多条SQL语句产生交错的auto-increment值。</p>
<p>由于insert语句常常涉及自增列的加锁过程，会涉及到AUTO-INC Locks加锁过程。<br>为了分步了解insert加锁过程，本文暂不讨论任何涉及自增列的加锁逻辑。</p>
<h5 id="三、InnoDB锁类型-2"><a href="#三、InnoDB锁类型-2" class="headerlink" title="三、InnoDB锁类型[^2]"></a>三、InnoDB锁类型[^2]</h5><h6 id="1-基本锁"><a href="#1-基本锁" class="headerlink" title="1. 基本锁"></a>1. 基本锁</h6><p>基本锁：共享锁(Shared Locks：S锁)与排他锁(Exclusive Locks：X锁)</p>
<p>mysql允许拿到S锁的事务读一行，允许拿到X锁的事务更新或删除一行。<br>加了S锁的记录，允许其他事务再加S锁，不允许其他事务再加X锁；<br>加了X锁的记录，不允许其他事务再加S锁或者X锁。</p>
<p>mysql对外提供加这两种锁的语法如下：<br>加S锁：select…lock in share mode<br>加X锁：select…for update</p>
<h6 id="2-意向锁-Intention-Locks"><a href="#2-意向锁-Intention-Locks" class="headerlink" title="2. 意向锁(Intention Locks)"></a>2. 意向锁(Intention Locks)</h6><p>InnoDB为了支持多粒度(表锁与行锁)的锁并存，引入意向锁。<br>意向锁是表级锁，可分为意向共享锁(IS锁)和意向排他锁(IX锁)。</p>
<blockquote>
<p>InnoDB supports multiple granularity locking which permits coexistence of row-level locks and locks on entire tables. To make locking at multiple granularity levels practical, additional types of locks called intention locks are used. Intention locks are table-level locks in InnoDB that indicate which type of lock (shared or exclusive) a transaction will require later for a row in that table. There are two types of intention locks used in InnoDB (assume that transaction T has requested a lock of the indicated type on table t):<br>Intention shared (IS): Transaction T intends to set S locks on individual rows in table t.<br>Intention exclusive (IX): Transaction T intends to set X locks on those rows.</p>
</blockquote>
<p>事务在请求S锁和X锁前，需要先获得对应的IS、IX锁。</p>
<blockquote>
<p>Before a transaction can acquire an S lock on a row in table t, it must first acquire an IS or stronger lock on t. Before a transaction can acquire an X lock on a row, it must first acquire an IX lock on t.</p>
</blockquote>
<p>意向锁产生的主要目的是为了处理行锁和表锁之间的冲突，用于表明“某个事务正在某一行上持有了锁，或者准备去持有锁”。</p>
<blockquote>
<p>The main purpose of IX and IS locks is to show that someone is locking a row, or going to lock a row in the table.</p>
</blockquote>
<p>共享锁、排他锁与意向锁的兼容矩阵如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">X</th>
<th style="text-align:center">IX</th>
<th style="text-align:center">S</th>
<th style="text-align:center">IS</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">X</td>
<td style="text-align:center"><code>冲突</code></td>
<td style="text-align:center"><code>冲突</code></td>
<td style="text-align:center"><code>冲突</code></td>
<td style="text-align:center"><code>冲突</code></td>
</tr>
<tr>
<td style="text-align:center">IX</td>
<td style="text-align:center"><code>冲突</code></td>
<td style="text-align:center">兼容</td>
<td style="text-align:center"><code>冲突</code></td>
<td style="text-align:center">兼容</td>
</tr>
<tr>
<td style="text-align:center">S</td>
<td style="text-align:center"><code>冲突</code></td>
<td style="text-align:center"><code>冲突</code></td>
<td style="text-align:center">兼容</td>
<td style="text-align:center">兼容</td>
</tr>
<tr>
<td style="text-align:center">IS</td>
<td style="text-align:center"><code>冲突</code></td>
<td style="text-align:center">兼容</td>
<td style="text-align:center">兼容</td>
<td style="text-align:center">兼容</td>
</tr>
</tbody>
</table>
<h6 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h6><p>从官方文档字面意思上看意向锁是表级锁，但是大牛不认为“Intention lock 是表级锁”[^5]?<br>另外，由于意向锁主要用于解决行锁与表锁间冲突问题，鉴于平时表级操作特别少，在分析加锁过程是否可以不用过多考虑意向锁的问题?</p>
<h6 id="3-行锁"><a href="#3-行锁" class="headerlink" title="3. 行锁"></a>3. 行锁</h6><h6 id="记录锁-Record-Locks"><a href="#记录锁-Record-Locks" class="headerlink" title="记录锁(Record Locks)"></a>记录锁(Record Locks)</h6><p>记录锁, 仅仅锁住索引记录的一行。<br>单条索引记录上加锁，record lock锁住的永远是索引，而非记录本身，即使该表上没有任何索引，那么innodb会在后台创建一个隐藏的聚集主键索引，那么锁住的就是这个隐藏的聚集主键索引。所以说当一条sql没有走任何索引时，那么将会在每一条聚集索引后面加X锁，这个类似于表锁，但原理上和表锁应该是完全不同的。</p>
<p>参见官方文档[^3]：</p>
<blockquote>
<p>If the table has no PRIMARY KEY or suitable UNIQUE index, InnoDB internally generates a hidden clustered index on a synthetic column containing row ID values. The rows are ordered by the ID that InnoDB assigns to the rows in such a table. The row ID is a 6-byte field that increases monotonically as new rows are inserted. Thus, the rows ordered by the row ID are physically in insertion order.</p>
</blockquote>
<h6 id="间隙锁-Gap-Locks"><a href="#间隙锁-Gap-Locks" class="headerlink" title="间隙锁(Gap Locks)"></a>间隙锁(Gap Locks)</h6><p>区间锁, 仅仅锁住一个索引区间(开区间)。<br>在索引记录之间的间隙中加锁，或者是在某一条索引记录之前或者之后加锁，并不包括该索引记录本身。</p>
<h6 id="next-key锁-Next-Key-Locks"><a href="#next-key锁-Next-Key-Locks" class="headerlink" title="next-key锁(Next-Key Locks)"></a>next-key锁(Next-Key Locks)</h6><p>record lock + gap lock, 左开右闭区间。</p>
<blockquote>
<p>A next-key lock is a combination of a record lock on the index record and a gap lock on the gap before the index record.</p>
<p>By default, InnoDB operates in REPEATABLE READ transaction isolation level and with the innodb_locks_unsafe_for_binlog system variable disabled. In this case, InnoDB uses next-key locks for searches and index scans, which prevents phantom rows。</p>
</blockquote>
<p>默认情况下，innodb使用next-key locks来锁定记录。<br>但当查询的索引含有唯一属性的时候，Next-Key Lock 会进行优化，将其降级为Record Lock，即仅锁住索引本身，不是范围。</p>
<h6 id="插入意向锁-Insert-Intention-Locks"><a href="#插入意向锁-Insert-Intention-Locks" class="headerlink" title="插入意向锁(Insert Intention Locks)"></a>插入意向锁(Insert Intention Locks)</h6><p>Gap Lock中存在一种插入意向锁（Insert Intention Lock），在insert操作时产生。在多事务同时写入不同数据至同一索引间隙的时候，并不需要等待其他事务完成，不会发生锁等待。<br>假设有一个记录索引包含键值4和7，不同的事务分别插入5和6，每个事务都会产生一个加在4-7之间的插入意向锁，获取在插入行上的排它锁，但是不会被互相锁住，因为数据行并不冲突。</p>
<blockquote>
<p>An insert intention lock is a type of gap lock set by INSERT operations prior to row insertion. This lock signals the intent to insert in such a way that multiple transactions inserting into the same index gap need not wait for each other if they are not inserting at the same position within the gap. Suppose that there are index records with values of 4 and 7. Separate transactions that attempt to insert values of 5 and 6, respectively, each lock the gap between 4 and 7 with insert intention locks prior to obtaining the exclusive lock on the inserted row, but do not block each other because the rows are nonconflicting.</p>
</blockquote>
<p>注：插入意向锁并非意向锁，而是一种特殊的间隙锁。</p>
<h6 id="4-行锁的兼容矩阵-4"><a href="#4-行锁的兼容矩阵-4" class="headerlink" title="4. 行锁的兼容矩阵[^4]"></a>4. 行锁的兼容矩阵[^4]</h6><table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">Gap</th>
<th style="text-align:center">Insert Intention</th>
<th style="text-align:center">Record</th>
<th style="text-align:center">Next-Key</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Gap</td>
<td style="text-align:center">兼容</td>
<td style="text-align:center">兼容</td>
<td style="text-align:center">兼容</td>
<td style="text-align:center">兼容</td>
</tr>
<tr>
<td style="text-align:center">Insert Intention</td>
<td style="text-align:center"><code>冲突</code></td>
<td style="text-align:center">兼容</td>
<td style="text-align:center">兼容</td>
<td style="text-align:center"><code>冲突</code></td>
</tr>
<tr>
<td style="text-align:center">Record</td>
<td style="text-align:center">兼容</td>
<td style="text-align:center">兼容</td>
<td style="text-align:center"><code>冲突</code></td>
<td style="text-align:center"><code>冲突</code></td>
</tr>
<tr>
<td style="text-align:center">Next-Key</td>
<td style="text-align:center">兼容</td>
<td style="text-align:center">兼容</td>
<td style="text-align:center"><code>冲突</code></td>
<td style="text-align:center"><code>冲突</code></td>
</tr>
</tbody>
</table>
<p>表注：横向是已经持有的锁，纵向是正在请求的锁。</p>
<p>由于S锁和S锁是完全兼容的，因此在判别兼容性时只考虑持有的锁与请求的锁是这三种组合情形：X、S和S、X和X、X。<br>另外，需要提醒注意的是进行兼容判断也只是针对于加锁涉及的行有交集的情形。</p>
<p>分析兼容矩阵可以得出如下几个结论：</p>
<ul>
<li>INSERT操作之间不会有冲突。</li>
<li>GAP,Next-Key会阻止Insert。</li>
<li>GAP和Record,Next-Key不会冲突</li>
<li>Record和Record、Next-Key之间相互冲突。</li>
<li>已有的Insert锁不阻止任何准备加的锁。</li>
</ul>
<h6 id="5-自增锁-AUTO-INC-Locks"><a href="#5-自增锁-AUTO-INC-Locks" class="headerlink" title="5. 自增锁(AUTO-INC Locks)"></a>5. 自增锁(AUTO-INC Locks)</h6><p>AUTO-INC锁是一种特殊的表级锁，发生涉及AUTO_INCREMENT列的事务性插入操作时产生。</p>
<p>官方解释如下[^3]：</p>
<blockquote>
<p>An AUTO-INC lock is a special table-level lock taken by transactions inserting into tables with AUTO_INCREMENT columns. In the simplest case, if one transaction is inserting values into the table, any other transactions must wait to do their own inserts into that table, so that rows inserted by the first transaction receive consecutive primary key values.</p>
</blockquote>
<h5 id="四、insert加锁过程"><a href="#四、insert加锁过程" class="headerlink" title="四、insert加锁过程"></a>四、insert加锁过程</h5><p>官方文档[^6]对于insert加锁的描述如下：</p>
<blockquote>
<p>INSERT sets an exclusive lock on the inserted row. This lock is an index-record lock, not a next-key lock (that is, there is no gap lock) and does not prevent other sessions from inserting into the gap before the inserted row.</p>
<p>Prior to inserting the row, a type of gap lock called an insert intention gap lock is set. This lock signals the intent to insert in such a way that multiple transactions inserting into the same index gap need not wait for each other if they are not inserting at the same position within the gap. Suppose that there are index records with values of 4 and 7. Separate transactions that attempt to insert values of 5 and 6 each lock the gap between 4 and 7 with insert intention locks prior to obtaining the exclusive lock on the inserted row, but do not block each other because the rows are nonconflicting.</p>
<p>If a duplicate-key error occurs, a shared lock on the duplicate index record is set. This use of a shared lock can result in deadlock should there be multiple sessions trying to insert the same row if another session already has an exclusive lock.</p>
</blockquote>
<p>简单的insert会在insert的行对应的索引记录上加一个排它锁，这是一个record lock，并没有gap，所以并不会阻塞其他session在gap间隙里插入记录。</p>
<p>不过在insert操作之前，还会加一种锁，官方文档称它为insertion intention gap lock，也就是意向的gap锁。这个意向gap锁的作用就是预示着当多事务并发插入相同的gap空隙时，只要插入的记录不是gap间隙中的相同位置，则无需等待其他session就可完成，这样就使得insert操作无须加真正的gap lock。<br>假设有一个记录索引包含键值4和7，不同的事务分别插入5和6，每个事务都会产生一个加在4-7之间的插入意向锁，获取在插入行上的排它锁，但是不会被互相锁住，因为数据行并不冲突。</p>
<p>假设发生了一个唯一键冲突错误，那么将会在重复的索引记录上加读锁。当有多个session同时插入相同的行记录时，如果另外一个session已经获得该行的排它锁，那么将会导致死锁。</p>
<h6 id="思考：Insert-Intention-Locks作用"><a href="#思考：Insert-Intention-Locks作用" class="headerlink" title="思考：Insert Intention Locks作用"></a>思考：Insert Intention Locks作用</h6><p>Insert Intention Locks的引入，我理解是为了提高数据插入的并发能力。<br>如果没有Insert Intention Locks的话，可能就需要使用Gap Locks来代替。</p>
<h5 id="五、insert死锁场景分析"><a href="#五、insert死锁场景分析" class="headerlink" title="五、insert死锁场景分析"></a>五、insert死锁场景分析</h5><p>接下来，带大家看几个与insert相关的死锁场景。</p>
<h6 id="表结构"><a href="#表结构" class="headerlink" title="表结构"></a>表结构</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `aa` (</span><br><span class="line">`id` int(10) unsigned NOT NULL COMMENT &apos;主键&apos;,</span><br><span class="line">`name` varchar(20) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;姓名&apos;,</span><br><span class="line">`age` int(11) NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;年龄&apos;,</span><br><span class="line">`stage` int(11) NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;关卡数&apos;,</span><br><span class="line">PRIMARY KEY (`id`),</span><br><span class="line">UNIQUE KEY `udx_name` (`name`),</span><br><span class="line">KEY `idx_stage` (`stage`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>
<h6 id="表数据"><a href="#表数据" class="headerlink" title="表数据"></a>表数据</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from aa;</span><br><span class="line">+----+------+-----+-------+</span><br><span class="line">| id | name | age | stage |</span><br><span class="line">+----+------+-----+-------+</span><br><span class="line">| 1  | yst  | 11  |     8 |</span><br><span class="line">| 2  | dxj  | 7   |     4 |</span><br><span class="line">| 3  | lb   | 13  |     7 |</span><br><span class="line">| 4  | zsq  | 5   |     7 |</span><br><span class="line">| 5  | lxr  | 13  |     4 |</span><br><span class="line">+----+------+-----+-------+</span><br></pre></td></tr></table></figure>
<h6 id="事务执行时序表"><a href="#事务执行时序表" class="headerlink" title="事务执行时序表"></a>事务执行时序表</h6><table>
<thead>
<tr>
<th style="text-align:center">T1(36727)</th>
<th style="text-align:center">T2(36728)</th>
<th style="text-align:center">T3(36729)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">begin;</td>
<td style="text-align:center">begin;</td>
<td style="text-align:center">begin;</td>
</tr>
<tr>
<td style="text-align:center">insert into aa values(6, ‘test’, 12, 3);</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">insert into aa values(6, ‘test’, 12, 3);</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">insert into aa values(6, ‘test’, 12, 3);</td>
</tr>
<tr>
<td style="text-align:center">rollback;</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">Query OK, 1 row affected (13.10 sec)</td>
</tr>
</tbody>
</table>
<p>如果T1未rollback，而是commit的话，T2和T3会报唯一键冲突：ERROR 1062 (23000): Duplicate entry ‘6’ for key ‘PRIMARY’</p>
<h6 id="事务锁占用情况"><a href="#事务锁占用情况" class="headerlink" title="事务锁占用情况"></a>事务锁占用情况</h6><p>T1 rollback前，各事务锁占用情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from information_schema.innodb_locks;</span><br><span class="line">+--------------+-------------+-----------+-----------+-------------+------------+------------+-----------+--</span><br><span class="line">| lock_id 	   | lock_trx_id | lock_mode | lock_type | lock_table  | lock_index | lock_space | lock_page | lock_rec       | lock_data   |</span><br><span class="line">+--------------+-------------+-----------+-----------+-------------+------------+------------+-----------+--</span><br><span class="line">| 36729:24:3:7 | 36729       | S 		 | RECORD 	 | `test`.`aa` | PRIMARY 	| 24 		 | 3 		 | 7 | 6 			|</span><br><span class="line">| 36727:24:3:7 | 36727       | X 		 | RECORD 	 | `test`.`aa` | PRIMARY 	| 24 		 | 3 		 | 7 | 6 			|</span><br><span class="line">| 36728:24:3:7 | 36728       | S 		 | RECORD 	 | `test`.`aa` | PRIMARY 	| 24 		 | 3 		 | 7 | 6 			|</span><br><span class="line">+--------------+-------------+-----------+-----------+-------------+------------+------------+-----------+--</span><br></pre></td></tr></table></figure>
<p>注：mysql有自己的一套规则来决定T2与T3哪个进行回滚，本文不做讨论。</p>
<h6 id="死锁日志"><a href="#死锁日志" class="headerlink" title="死锁日志"></a>死锁日志</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">------------------------</span><br><span class="line">LATEST DETECTED DEADLOCK</span><br><span class="line">------------------------</span><br><span class="line">2016-07-21 19:34:23 700000a3f000</span><br><span class="line">*** (1) TRANSACTION:</span><br><span class="line">TRANSACTION 36728, ACTIVE 199 sec inserting</span><br><span class="line">mysql tables in use 1, locked 1</span><br><span class="line">LOCK WAIT 4 lock struct(s), heap size 1184, 2 row lock(s)</span><br><span class="line">MySQL thread id 13, OS thread handle 0x700000b0b000, query id 590 localhost root update</span><br><span class="line">insert into aa values(6, &apos;test&apos;, 12, 3)</span><br><span class="line">*** (1) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 24 page no 3 n bits 80 index `PRIMARY` of table `test`.`aa` trx id 36728 lock_mode X insert intention waiting</span><br><span class="line">Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0</span><br><span class="line">0: len 8; hex 73757072656d756d; asc supremum;;</span><br><span class="line">*** (2) TRANSACTION:</span><br><span class="line">TRANSACTION 36729, ACTIVE 196 sec inserting</span><br><span class="line">mysql tables in use 1, locked 1</span><br><span class="line">4 lock struct(s), heap size 1184, 2 row lock(s)</span><br><span class="line">MySQL thread id 14, OS thread handle 0x700000a3f000, query id 591 localhost root update</span><br><span class="line">insert into aa values(6, &apos;test&apos;, 12, 3)</span><br><span class="line">*** (2) HOLDS THE LOCK(S):</span><br><span class="line">RECORD LOCKS space id 24 page no 3 n bits 80 index `PRIMARY` of table `test`.`aa` trx id 36729 lock mode S</span><br><span class="line">Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0</span><br><span class="line">0: len 8; hex 73757072656d756d; asc supremum;;</span><br><span class="line">*** (2) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 24 page no 3 n bits 80 index `PRIMARY` of table `test`.`aa` trx id 36729 lock_mode X insert intention waiting</span><br><span class="line">Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0</span><br><span class="line">0: len 8; hex 73757072656d756d; asc supremum;;</span><br><span class="line">*** WE ROLL BACK TRANSACTION (2)</span><br></pre></td></tr></table></figure>
<h6 id="死锁成因"><a href="#死锁成因" class="headerlink" title="死锁成因"></a>死锁成因</h6><p>事务T1成功插入记录，并获得索引id=6上的排他记录锁(LOCK_X | LOCK_REC_NOT_GAP)。<br>紧接着事务T2、T3也开始插入记录，请求排他插入意向锁(LOCK_X | LOCK_GAP | LOCK_INSERT_INTENTION)；但由于发生重复唯一键冲突，各自请求的排他记录锁(LOCK_X | LOCK_REC_NOT_GAP)转成共享记录锁(LOCK_S | LOCK_REC_NOT_GAP)。</p>
<p>T1回滚释放索引id=6上的排他记录锁(LOCK_X | LOCK_REC_NOT_GAP)，T2和T3都要请求索引id=6上的排他记录锁(LOCK_X | LOCK_REC_NOT_GAP)。<br>由于X锁与S锁互斥，T2和T3都等待对方释放S锁。<br>于是，死锁便产生了。</p>
<p>如果此场景下，只有两个事务T1与T2或者T1与T3，则不会引发如上死锁情况产生。</p>
<h6 id="思考-1"><a href="#思考-1" class="headerlink" title="思考"></a>思考</h6><ul>
<li>为什么发现重复主键冲突的时候，要将事务请求的X锁转成S锁？<br>(比较牵强的)个人理解，跟插入意向锁类型，也是为了提高插入的并发效率。</li>
<li>插入前请求插入意向锁的作用？<br>个人认为，通过兼容矩阵来分析，Insert Intention Locks是为了减少插入时的锁冲突。</li>
</ul>
<h6 id="2-GAP与Insert-Intention冲突引发的死锁"><a href="#2-GAP与Insert-Intention冲突引发的死锁" class="headerlink" title="2. GAP与Insert Intention冲突引发的死锁"></a>2. GAP与Insert Intention冲突引发的死锁</h6><h6 id="表结构-1"><a href="#表结构-1" class="headerlink" title="表结构"></a>表结构</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `t` (</span><br><span class="line">`a` int(11) NOT NULL,</span><br><span class="line">`b` int(11) DEFAULT NULL,</span><br><span class="line">PRIMARY KEY (`a`),</span><br><span class="line">KEY `idx_b` (`b`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>
<h6 id="表数据-1"><a href="#表数据-1" class="headerlink" title="表数据"></a>表数据</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from t;</span><br><span class="line">+----+------+</span><br><span class="line">| a  | b 	|</span><br><span class="line">+----+------+</span><br><span class="line">| 1  | 2 	|</span><br><span class="line">| 2  | 3 	|</span><br><span class="line">| 3  | 4 	|</span><br><span class="line">| 11 | 22 	|</span><br><span class="line">+----+------+</span><br></pre></td></tr></table></figure>
<h6 id="事务执行时序表-1"><a href="#事务执行时序表-1" class="headerlink" title="事务执行时序表"></a>事务执行时序表</h6><table>
<thead>
<tr>
<th style="text-align:center">T1(36831)</th>
<th style="text-align:center">T2(36832)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">begin;</td>
<td style="text-align:center">begin;</td>
</tr>
<tr>
<td style="text-align:center">select * from t where b = 6 for update;</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">select * from t where b = 8 for update;</td>
</tr>
<tr>
<td style="text-align:center">insert into t values (4,5);</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">insert into t values (4,5);</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction</td>
</tr>
<tr>
<td style="text-align:center">Query OK, 1 row affected (5.45 sec)</td>
</tr>
</tbody>
</table>
<h6 id="事务锁占用情况-1"><a href="#事务锁占用情况-1" class="headerlink" title="事务锁占用情况"></a>事务锁占用情况</h6><p>T2 insert前，各事务锁占用情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from information_schema.innodb_locks;</span><br><span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+---</span><br><span class="line">| lock_id 	   | lock_trx_id | lock_mode | lock_type | lock_table | lock_index | lock_space | lock_page | lock_rec 		 | lock_data   |</span><br><span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+---</span><br><span class="line">| 36831:25:4:5 | 36831 		 | X,GAP 	 | RECORD 	 | `test`.`t` | idx_b 	   | 25 		| 4 		| 5 | 22, 11 	   |</span><br><span class="line">| 36832:25:4:5 | 36832 		 | X,GAP 	 | RECORD 	 | `test`.`t` | idx_b 	   | 25 		| 4 		| 5 | 22, 11 	   |</span><br><span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+---</span><br></pre></td></tr></table></figure>
<h6 id="死锁日志-1"><a href="#死锁日志-1" class="headerlink" title="死锁日志"></a>死锁日志</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">------------------------</span><br><span class="line">LATEST DETECTED DEADLOCK</span><br><span class="line">------------------------</span><br><span class="line">2016-07-28 12:28:34 700000a3f000</span><br><span class="line">*** (1) TRANSACTION:</span><br><span class="line">TRANSACTION 36831, ACTIVE 17 sec inserting</span><br><span class="line">mysql tables in use 1, locked 1</span><br><span class="line">LOCK WAIT 4 lock struct(s), heap size 1184, 3 row lock(s), undo log entries 1</span><br><span class="line">MySQL thread id 38, OS thread handle 0x700000b0b000, query id 953 localhost root update</span><br><span class="line">insert into t values (4,5)</span><br><span class="line">*** (1) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 25 page no 4 n bits 72 index `idx_b` of table `test`.`t` trx id 36831 lock_mode X locks gap before rec insert intention waiting</span><br><span class="line">Record lock, heap no 5 PHYSICAL RECORD: n_fields 2; compact format; info bits 0</span><br><span class="line">0: len 4; hex 80000016; asc ;;</span><br><span class="line">1: len 4; hex 8000000b; asc ;;</span><br><span class="line">*** (2) TRANSACTION:</span><br><span class="line">TRANSACTION 36832, ACTIVE 13 sec inserting</span><br><span class="line">mysql tables in use 1, locked 1</span><br><span class="line">3 lock struct(s), heap size 360, 2 row lock(s)</span><br><span class="line">MySQL thread id 39, OS thread handle 0x700000a3f000, query id 954 localhost root update</span><br><span class="line">insert into t values (4,5)</span><br><span class="line">*** (2) HOLDS THE LOCK(S):</span><br><span class="line">RECORD LOCKS space id 25 page no 4 n bits 72 index `idx_b` of table `test`.`t` trx id 36832 lock_mode X locks gap before rec</span><br><span class="line">Record lock, heap no 5 PHYSICAL RECORD: n_fields 2; compact format; info bits 0</span><br><span class="line">0: len 4; hex 80000016; asc ;;</span><br><span class="line">1: len 4; hex 8000000b; asc ;;</span><br><span class="line">*** (2) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 25 page no 3 n bits 72 index `PRIMARY` of table `test`.`t` trx id 36832 lock mode S locks rec but not gap waiting</span><br><span class="line">Record lock, heap no 5 PHYSICAL RECORD: n_fields 4; compact format; info bits 0</span><br><span class="line">0: len 4; hex 80000004; asc ;;</span><br><span class="line">1: len 6; hex 000000008fdf; asc ;;</span><br><span class="line">2: len 7; hex 8d000001d00110; asc ;;</span><br><span class="line">3: len 4; hex 80000005; asc ;;</span><br><span class="line">*** WE ROLL BACK TRANSACTION (2)</span><br></pre></td></tr></table></figure>
<h6 id="死锁成因-1"><a href="#死锁成因-1" class="headerlink" title="死锁成因"></a>死锁成因</h6><p>事务T1执行查询语句，在索引b=6上加排他Next-key锁(LOCK_X | LOCK_ORDINARY)，会锁住idx_b索引范围(4, 22)。<br>事务T2执行查询语句，在索引b=8上加排他Next-key锁(LOCK_X | LOCK_ORDINARY)，会锁住idx_b索引范围(4, 22)。由于请求的GAP与已持有的GAP是兼容的，因此，事务T2在idx_b索引范围(4, 22)也能加锁成功。</p>
<p>事务T1执行插入语句，会先加排他Insert Intention锁。由于请求的Insert Intention锁与已有的GAP锁不兼容，则事务T1等待T2释放GAP锁。<br>事务T2执行插入语句，也会等待T1释放GAP锁。<br>于是，死锁便产生了。</p>
<p>注：LOCK_ORDINARY拥有LOCK_GAP一部分特性。</p>
<h6 id="思考：Insert-Intention锁在加哪级索引上？"><a href="#思考：Insert-Intention锁在加哪级索引上？" class="headerlink" title="思考：Insert Intention锁在加哪级索引上？"></a>思考：Insert Intention锁在加哪级索引上？</h6><p>这个排他锁加在PK上，还是二级索引上？</p>
<h5 id="七、补充知识"><a href="#七、补充知识" class="headerlink" title="七、补充知识"></a>七、补充知识</h5><h6 id="1-查看事务隔离级别"><a href="#1-查看事务隔离级别" class="headerlink" title="1. 查看事务隔离级别"></a>1. 查看事务隔离级别</h6><p>SELECT @@global.tx_isolation;<br>SELECT @@session.tx_isolation;<br>SELECT @@tx_isolation;</p>
<h6 id="2-设置隔离级别"><a href="#2-设置隔离级别" class="headerlink" title="2. 设置隔离级别"></a>2. 设置隔离级别</h6><p>SET [SESSION | GLOBAL] TRANSACTION ISOLATION LEVEL {READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE}<br>例如：set session transaction isolation level read uncommitted;</p>
<h6 id="3-查看auto-increment机制模式"><a href="#3-查看auto-increment机制模式" class="headerlink" title="3. 查看auto_increment机制模式"></a>3. 查看auto_increment机制模式</h6><p>show variables like ‘innodb_autoinc_lock_mode’;</p>
<h6 id="4-查看表状态"><a href="#4-查看表状态" class="headerlink" title="4. 查看表状态"></a>4. 查看表状态</h6><p>show table status like ‘plan_branch’\G;<br>show table status from test like ‘plan_branch’\G;</p>
<h6 id="5-查看SQL性能"><a href="#5-查看SQL性能" class="headerlink" title="5. 查看SQL性能"></a>5. 查看SQL性能</h6><p>show profiles<br>show profile for query 1;</p>
<h6 id="6-查看当前最新事务ID"><a href="#6-查看当前最新事务ID" class="headerlink" title="6. 查看当前最新事务ID"></a>6. 查看当前最新事务ID</h6><p>每开启一个新事务，记录当前最新事务的id，可用于后续死锁分析。<br>show engine innodb status\G;</p>
<h6 id="7-查看事务锁等待状态情况"><a href="#7-查看事务锁等待状态情况" class="headerlink" title="7. 查看事务锁等待状态情况"></a>7. 查看事务锁等待状态情况</h6><p>select from information_schema.innodb_locks;<br>select from information_schema.innodb_lock_waits;<br>select * from information_schema.innodb_trx;</p>
<h6 id="8-查看innodb状态-包含最近的死锁日志"><a href="#8-查看innodb状态-包含最近的死锁日志" class="headerlink" title="8. 查看innodb状态(包含最近的死锁日志)"></a>8. 查看innodb状态(包含最近的死锁日志)</h6><p>show engine innodb status;</p>
<h5 id="八、参考文档"><a href="#八、参考文档" class="headerlink" title="八、参考文档"></a>八、参考文档</h5><p>[^1]: <a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-parameters.html" target="_blank" rel="noopener">InnoDB Startup Options and System Variables</a><br>[^2]: <a href="http://dev.mysql.com/doc/refman/5.6/en/innodb-locking.html" target="_blank" rel="noopener">InnoDB Locking</a><br>[^3]: <a href="http://dev.mysql.com/doc/refman/5.6/en/innodb-index-types.html" target="_blank" rel="noopener">Clustered and Secondary Indexes</a><br>[^4]: <a href="http://www.cnblogs.com/renolei/p/4673842.html" target="_blank" rel="noopener">[MySQL] gap lock/next-key lock浅析</a><br>[^5]: <a href="http://hedengcheng.com/?p=771#comment-5543" target="_blank" rel="noopener">Intention Lock是否表级锁</a><br>[^6]: <a href="http://dev.mysql.com/doc/refman/5.6/en/innodb-locks-set.html" target="_blank" rel="noopener">Locks Set by Different SQL Statements in InnoDB</a><br>[^8]: <a href="http://www.cnblogs.com/renolei/p/5559135.html" target="_blank" rel="noopener">AUTO_INCREMENT lock Handing in InnoDB</a><br>[^9]: <a href="http://blog.csdn.net/cug_jiang126com/article/details/50596729" target="_blank" rel="noopener">深入理解innodb的锁(record,gap,Next-Key lock)</a><br>[^11]: <a href="http://dev.mysql.com/doc/refman/5.5/en/innodb-locks-table.html" target="_blank" rel="noopener">The INFORMATION_SCHEMA INNODB_LOCKS Table</a><br>[^12]: <a href="http://dev.mysql.com/doc/refman/5.5/en/innodb-trx-table.html" target="_blank" rel="noopener">The INFORMATION_SCHEMA INNODB_TRX Table</a><br>[^13]: <a href="http://blog.csdn.net/yanzongshuai/article/details/46398609" target="_blank" rel="noopener">mysql innodb插入意向锁</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">本文标题:mysql insert锁机制</span><br><span class="line">文章作者:yeshaoting</span><br><span class="line">原始链接:http://yeshaoting.cn/article/database/mysql insert锁机制/</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    
      <div>
        <div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/uploads/wechat.jpg" alt="BaiZe wechat" style="width: 200px; max-width: 100%;">
    <div>欢迎扫描二维码关注公众号一起成长~</div>
</div>

      </div>
    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>觉得文章对您有帮助请我喝杯咖啡吧^_^</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.png" alt="BaiZe 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/工作总结/" rel="tag"><i class="fas fa-tag"></i> 工作总结</a>
          
        </div>
      

      
      
      

      
        <div>
	  <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    BaiZe
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://woshibaize.github.io/2020/02/01/每日总结/20200201/" title="insert是行锁还是表锁？">https://woshibaize.github.io/2020/02/01/每日总结/20200201/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章均采用 <a href rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议，转载请注明出处！
  </li>
</ul>

        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/01/31/每日总结/20200131/" rel="next" title="MySQL是行级锁还是表级锁">
                <i class="fas fa-chevron-left"></i> MySQL是行级锁还是表级锁
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/02/05/每日总结/20200205/" rel="prev" title="过滤器与拦截器的区别">
                过滤器与拦截器的区别 <i class="fas fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80MzY0My8yMDE4Mg=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
	        <img class="site-avatar-plug-bilibili">
                <img class="site-author-image-bilibili" itemprop="image" src="/images/avatar.png" alt="点击头像试试看~~">
	    
              <p class="site-author-name" itemprop="name">BaiZe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">39</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            
          </nav>

          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa-fw link"></i>
                <i class="fas fa-hand-holding-heart fa-flip-horizontal"></i> 书签 <i class="fas fa-hand-holding-heart"></i>
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://edu.aliyun.com/developer?spm=5176.10731491.0.0.690970d7ep7eIP" title="阿里云大学开发者课堂" target="_blank">阿里云大学开发者课堂</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.jikexueyuan.com/" title="极客学院" target="_blank">极客学院</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.imooc.com/" title="慕课网" target="_blank">慕课网</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.zhizuobiao.com/courseCenter/index?courseAndGoodsName=iOS" title="职坐标" target="_blank">职坐标</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.coder520.com/courses?type=1" title="码码在线" target="_blank">码码在线</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.gulixueyuan.com/" title="谷粒学院" target="_blank">谷粒学院</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://study.163.com/" title="网易云课堂" target="_blank">网易云课堂</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.javalearns.com/" title="java学习网" target="_blank">java学习网</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.runoob.com/coder-learn-path" title="菜鸟教程" target="_blank">菜鸟教程</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.liaoxuefeng.com/" title="廖雪峰" target="_blank">廖雪峰</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://jijiangshe.com/resources/all" title="技匠社" target="_blank">技匠社</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://how2j.cn/" title="HOW2J.CN" target="_blank">HOW2J.CN</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.zimug.com/" title="字母哥博客" target="_blank">字母哥博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.yiibai.com/" title="易百教程" target="_blank">易百教程</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://mirrors.tuna.tsinghua.edu.cn/" title="清华大学开源软件镜像" target="_blank">清华大学开源软件镜像</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://stackoverflow.com/" title="StackOverFlow" target="_blank">StackOverFlow</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.enboo.cn/" title="开源之家" target="_blank">开源之家</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.mn886.net/jqGrid/" title="jqGrid" target="_blank">jqGrid</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://code520.net/" title="code520" target="_blank">code520</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.iocoder.cn/" title="芋道源码" target="_blank">芋道源码</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://thesecretlivesofdata.com/raft/" title="Raft算法" target="_blank">Raft算法</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.bootcss.com/" title="Bootstrap中文网" target="_blank">Bootstrap中文网</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.jq22.com/" title="JQuery插件库" target="_blank">JQuery插件库</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.treejs.cn/v3/main.php#_zTreeInfo" title="zTree" target="_blank">zTree</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://dromara.org/website/zh-cn/" title="dromara开源框架" target="_blank">dromara开源框架</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://github.com/apache/dubbo-admin" title="dubbo-admin" target="_blank">dubbo-admin</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://github.com/caoxinyu/RedisClient/releases" title="RedisClient" target="_blank">RedisClient</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://docs.gitlab.com/runner/register/index.html" title="gitlab-runner" target="_blank">gitlab-runner</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/#" title="kubernetes官网" target="_blank">kubernetes官网</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.kubernetes.org.cn/" title="kubernetes中文社区" target="_blank">kubernetes中文社区</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.kuboard.cn/" title="kubernetes-kuboard" target="_blank">kubernetes-kuboard</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.kettle.net.cn/pagedownload/dfadflefasdfsadfweasfd" title="kettle中文网" target="_blank">kettle中文网</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.apachefriends.org/zh_cn/index.html" title="PHP集成环境" target="_blank">PHP集成环境</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.jumpserver.org/" title="jumpserver堡垒机" target="_blank">jumpserver堡垒机</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://github.com/hankcs/HanLP" title="HanLP中文分词" target="_blank">HanLP中文分词</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://xiumi.us/#/" title="新媒体运营-秀米" target="_blank">新媒体运营-秀米</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.zcool.com.cn/" title="新媒体运营-站库" target="_blank">新媒体运营-站库</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://818ps.com/?user_source=r53712&route_id=15560965234965&route=1&after_route=" title="新媒体运营-图怪兽" target="_blank">新媒体运营-图怪兽</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://huaban.com/" title="新媒体运营-花瓣网" target="_blank">新媒体运营-花瓣网</a>
                  </li>
                
              </ul>
            </div>
          

			<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="260" height="52" src="http://s128.xiami.net/989/2110241989/2102863977/1796814242_1506409575105.mp3?ccode=xiami__&expire=86400&duration=180&psid=6b4cca524832e36ebe0f1e0a51e0ed5a&ups_client_netip=null&ups_ts=1577544718&ups_userid=0&utid=&vid=1796814242&fn=1796814242_1506409575105.mp3&vkey=Ba48776dff5a04c4dd519c0043269b8ef" style="display:none"></iframe>
			
          
        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Insert是行锁还是表锁？"><span class="nav-text">Insert是行锁还是表锁？</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#一、前言"><span class="nav-text">一、前言</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#二、现场状态"><span class="nav-text">二、现场状态</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-数据库版本"><span class="nav-text">1.数据库版本</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-数据库引擎"><span class="nav-text">2.数据库引擎</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-事务隔离级别"><span class="nav-text">3.事务隔离级别</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-查看gap锁开启状态"><span class="nav-text">4.查看gap锁开启状态</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-查看自增锁模式"><span class="nav-text">5. 查看自增锁模式</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#三、InnoDB锁类型-2"><span class="nav-text">三、InnoDB锁类型[^2]</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-基本锁"><span class="nav-text">1. 基本锁</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-意向锁-Intention-Locks"><span class="nav-text">2. 意向锁(Intention Locks)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#思考"><span class="nav-text">思考</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-行锁"><span class="nav-text">3. 行锁</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#记录锁-Record-Locks"><span class="nav-text">记录锁(Record Locks)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#间隙锁-Gap-Locks"><span class="nav-text">间隙锁(Gap Locks)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#next-key锁-Next-Key-Locks"><span class="nav-text">next-key锁(Next-Key Locks)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#插入意向锁-Insert-Intention-Locks"><span class="nav-text">插入意向锁(Insert Intention Locks)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-行锁的兼容矩阵-4"><span class="nav-text">4. 行锁的兼容矩阵[^4]</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-自增锁-AUTO-INC-Locks"><span class="nav-text">5. 自增锁(AUTO-INC Locks)</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#四、insert加锁过程"><span class="nav-text">四、insert加锁过程</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#思考：Insert-Intention-Locks作用"><span class="nav-text">思考：Insert Intention Locks作用</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#五、insert死锁场景分析"><span class="nav-text">五、insert死锁场景分析</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#表结构"><span class="nav-text">表结构</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#表数据"><span class="nav-text">表数据</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#事务执行时序表"><span class="nav-text">事务执行时序表</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#事务锁占用情况"><span class="nav-text">事务锁占用情况</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#死锁日志"><span class="nav-text">死锁日志</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#死锁成因"><span class="nav-text">死锁成因</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#思考-1"><span class="nav-text">思考</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-GAP与Insert-Intention冲突引发的死锁"><span class="nav-text">2. GAP与Insert Intention冲突引发的死锁</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#表结构-1"><span class="nav-text">表结构</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#表数据-1"><span class="nav-text">表数据</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#事务执行时序表-1"><span class="nav-text">事务执行时序表</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#事务锁占用情况-1"><span class="nav-text">事务锁占用情况</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#死锁日志-1"><span class="nav-text">死锁日志</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#死锁成因-1"><span class="nav-text">死锁成因</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#思考：Insert-Intention锁在加哪级索引上？"><span class="nav-text">思考：Insert Intention锁在加哪级索引上？</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#七、补充知识"><span class="nav-text">七、补充知识</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-查看事务隔离级别"><span class="nav-text">1. 查看事务隔离级别</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-设置隔离级别"><span class="nav-text">2. 设置隔离级别</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-查看auto-increment机制模式"><span class="nav-text">3. 查看auto_increment机制模式</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-查看表状态"><span class="nav-text">4. 查看表状态</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-查看SQL性能"><span class="nav-text">5. 查看SQL性能</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#6-查看当前最新事务ID"><span class="nav-text">6. 查看当前最新事务ID</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#7-查看事务锁等待状态情况"><span class="nav-text">7. 查看事务锁等待状态情况</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#8-查看innodb状态-包含最近的死锁日志"><span class="nav-text">8. 查看innodb状态(包含最近的死锁日志)</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#八、参考文档"><span class="nav-text">八、参考文档</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fas fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">BaiZe</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fas fa-chart-area"></i>
    </span>
    
      <span class="post-meta-item-text">全站共计字数&#58;</span>
    
    <span title="全站共计字数">55.7k</span>
  
</div>








        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fas fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    <div class="sidebar_wo">
      <div id="leimu">
        <img src="/images/b2t/leimuA.png" alt="雷姆" onmouseover="this.src='/images/b2t/leimuB.png'" onmouseout="this.src='/images/b2t/leimuA.png'" title="回到顶部">
      </div>
      <div class="sidebar_wo" id="lamu">
        <img src="/images/b2t/lamuA.png" alt="雷姆" onmouseover="this.src='/images/b2t/lamuB.png'" onmouseout="this.src='/images/b2t/lamuA.png'" title="回到底部">
      </div>
    </div>

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fas fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="far fa-frown fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  


  
<!-- 图片轮播js文件cdn -->
<script src="https://cdn.bootcss.com/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>

<!-- 剪贴板js文件 -->
<script type="text/javascript" src="/lib/zclip/clipboard.min.js"></script>

<script>

<!-- 头像挂件及自动刷新 -->

    $(function () {
        $(".site-avatar-plug-bilibili").attr("src", "/images/avatar-plug/bilibili_" + (~~(44*Math.random())+1) + ".png");
    });


</script>

<!-- 自定义的js文件 -->
<script type="text/javascript" src="/js/src/custom.js"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?a84a10965b0e13b3bf2d22960408192c"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body>
</html>
